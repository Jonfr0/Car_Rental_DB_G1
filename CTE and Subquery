-- CTE
-- Use a CTE to calculate each branchâ€™s monthly revenue.
-- Business purpose: To summarize how much revenue each branch generates every month. 
-- This helps track branch performance on a monthly basis, supports budgeting, and identifies trends or branches needing attention.

WITH DailyRevenue AS (
    SELECT
        branch_id,
        CAST(invoice_date AS DATE) AS revenue_date,
        SUM(total_amount) AS daily_revenue
    FROM Finance.Invoice
    GROUP BY branch_id, CAST(invoice_date AS DATE)
)
SELECT
    branch_id,
    revenue_date,
    daily_revenue
FROM DailyRevenue
ORDER BY branch_id, revenue_date;

-- Subquery 
-- Use subquery to find customers whose total rental spending is above the average customer spending.
-- The business purpose: Identifies customers who spend more than average on rentals.
-- This is useful for marketing target, loyalty programs, and maximizing revenue from high-value clients
SELECT customer_id, SUM(rental_total) AS total_spent
FROM Rental.Rental
GROUP BY customer_id
HAVING SUM(rental_total) > (
    SELECT AVG(customer_total)
    FROM (
        SELECT SUM(rental_total) AS customer_total
        FROM Rental.Rental
        GROUP BY customer_id
    ) AS totals
)
ORDER BY total_spent DESC;



